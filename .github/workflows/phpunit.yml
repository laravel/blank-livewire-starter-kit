name: CI - Tests

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v4
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, sqlite, xml, curl, zip, gd
          ini-values: memory_limit=2G

      - name: Cache Composer packages
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install Composer dependencies
        run: composer install --no-progress --prefer-dist --no-suggest --ansi

      - name: Prepare environment
        run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"
          php artisan key:generate --ansi

      - name: Run Pint (linter) âœ…
        run: composer run test:lint

      - name: Run tests (PHPUnit)
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
        run: |
          vendor/bin/phpunit --testdox --colors=never --log-junit junit.xml

      - name: Run coverage (phpdbg)
        env:
          APP_ENV: testing
          DB_CONNECTION: sqlite
          DB_DATABASE: ':memory:'
          QUEUE_CONNECTION: sync
          MAIL_MAILER: array
        run: |
          phpdbg -qrr vendor/bin/phpunit --coverage-clover=clover.xml --colors=never

      - name: Upload PHPUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-junit
          path: junit.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: phpunit-coverage
          path: clover.xml

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: clover.xml
        continue-on-error: true
